<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gen 2 Pokemon Ranker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5vh;
            padding-top: max(0.5vh, env(safe-area-inset-top));
            padding-bottom: max(0.5vh, env(safe-area-inset-bottom));
            height: 100dvh;
            max-height: 100dvh;
            overflow: hidden;
        }
        
        h1 {
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            margin-bottom: 0.3vh;
            text-align: center;
            font-size: 2.5vh;
        }
        
        .progress {
            color: white;
            font-size: 1.8vh;
            margin-bottom: 0.3vh;
        }
        
        .progress-bar {
            width: 80%;
            max-width: 30vh;
            height: 1vh;
            background: rgba(255,255,255,0.3);
            border-radius: 0.5vh;
            margin-bottom: 0.5vh;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #4ade80;
            transition: width 0.3s ease;
        }
        
        .instructions {
            color: white;
            text-align: center;
            margin-bottom: 0.3vh;
            font-size: 1.8vh;
            padding: 0 5px;
        }
        
        .selection-count {
            color: #4ade80;
            font-size: 2vh;
            font-weight: bold;
            margin-bottom: 0.2vh;
        }
        
        .hint {
            color: rgba(255,255,255,0.7);
            font-size: 1.5vh;
            margin-bottom: 0.5vh;
            font-style: italic;
        }
        
        .batch-container {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            grid-template-rows: repeat(5, 1fr);
            gap: 0.5vh;
            width: 100%;
            max-width: 50vh;
            flex: 1;
            min-height: 0;
        }
        
        .pokemon-card {
            background: white;
            border-radius: 0.8vh;
            padding: 0.3vh;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 0 0.3vh 1vh rgba(0,0,0,0.2);
            text-align: center;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .pokemon-card:active {
            transform: scale(0.95);
        }
        
        .pokemon-card.selected {
            background: #4ade80;
            border: 3px solid #22c55e;
        }
        
        .pokemon-card.selected .name,
        .pokemon-card.selected .number {
            color: white;
        }
        
        .pokemon-card img {
            max-height: 8vh;
            max-width: 100%;
            width: auto;
            height: auto;
            image-rendering: pixelated;
            margin-top: 0.5vh;
        }
        
        .pokemon-card .name {
            color: #333;
            font-size: 1.4vh;
            font-weight: bold;
            line-height: 1;
            margin-top: 0.5vh;
        }
        
        .pokemon-card .species {
            color: #333;
            font-size: 1.2vh;
            font-style: italic;
            line-height: 1;
            margin-top: 0.2vh;
        }
        
        .pokemon-card.selected .species {
            color: rgba(255,255,255,0.85);
        }
        
        .pokemon-card .number {
            display: none;
        }
        
        .round-info {
            color: white;
            font-size: 2.2vh;
            font-weight: bold;
            margin-bottom: 0.3vh;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
        
        .btn-row {
            display: flex;
            gap: 1.5vh;
            justify-content: center;
            margin-top: 0.8vh;
        }
        
        .next-btn, .back-btn, .undo-btn {
            padding: 1.2vh 2.5vh;
            font-size: 2vh;
            color: white;
            border: none;
            border-radius: 1vh;
            cursor: pointer;
            box-shadow: 0 0.3vh 1vh rgba(0,0,0,0.2);
            touch-action: manipulation;
        }
        
        .next-btn {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
        }
        
        .back-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .undo-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .next-btn:active, .back-btn:active, .undo-btn:active {
            transform: scale(0.95);
        }
        
        .next-btn:disabled, .back-btn:disabled, .undo-btn:disabled {
            background: #888;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Pairwise battle styles */
        .battle-container {
            display: none;
            flex-direction: row;
            gap: 2vh;
            align-items: center;
            justify-content: center;
            flex: 1;
            width: 100%;
        }
        
        .battle-card {
            background: white;
            border-radius: 1.5vh;
            padding: 1vh 0.8vh;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 0.8vh 2.5vh rgba(0,0,0,0.25);
            text-align: center;
            flex: 1;
            max-width: 42vw;
            touch-action: manipulation;
        }
        
        .battle-card:active {
            transform: scale(0.95);
            background: #4ade80;
        }
        
        .battle-card:active .name,
        .battle-card:active .number {
            color: white;
        }
        
        .battle-card img {
            max-height: 35vh;
            max-width: 100%;
            width: auto;
            height: auto;
            image-rendering: pixelated;
        }
        
        .battle-card .name {
            margin-top: 0.5vh;
            color: #333;
            font-size: 2.2vh;
            font-weight: bold;
        }
        
        .battle-card .number {
            color: #888;
            font-size: 1.8vh;
        }
        
        .battle-card .desc {
            color: #666;
            font-size: 1.3vh;
            font-style: italic;
            margin-top: 0.5vh;
            line-height: 1.3;
            max-height: 5vh;
            overflow: hidden;
        }
        
        /* Type badge styles */
        .type-container {
            display: flex;
            gap: 0.3vh;
            justify-content: center;
            margin-top: 0.2vh;
            flex-wrap: wrap;
        }
        
        .type-badge {
            font-size: 1vh;
            padding: 0.2vh 0.5vh;
            border-radius: 0.3vh;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            text-shadow: 0 1px 1px rgba(0,0,0,0.3);
        }
        
        .battle-card .type-badge {
            font-size: 1.5vh;
            padding: 0.3vh 0.8vh;
        }
        
        .rank-card .type-badge, .ranking-item .type-badge {
            font-size: 0.55em;
            padding: 1px 4px;
        }
        
        .type-normal { background: #A8A878; }
        .type-fire { background: #F08030; }
        .type-water { background: #6890F0; }
        .type-electric { background: #F8D030; color: #333; }
        .type-grass { background: #78C850; }
        .type-ice { background: #98D8D8; color: #333; }
        .type-fighting { background: #C03028; }
        .type-poison { background: #A040A0; }
        .type-ground { background: #E0C068; color: #333; }
        .type-flying { background: #A890F0; }
        .type-psychic { background: #F85888; }
        .type-bug { background: #A8B820; }
        .type-rock { background: #B8A038; }
        .type-ghost { background: #705898; }
        .type-dragon { background: #7038F8; }
        .type-dark { background: #705848; }
        .type-steel { background: #B8B8D0; color: #333; }
        .type-fairy { background: #EE99AC; }
        
        .vs {
            font-size: 4vh;
            color: white;
            font-weight: bold;
            text-shadow: 0.3vh 0.3vh 0.5vh rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        
        #results {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            text-align: center;
            width: 100%;
            max-width: 400px;
            flex: 1;
            overflow: hidden;
            display: none;
            flex-direction: column;
        }
        
        #results h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .top-pokemon {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .rank-card {
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            border-radius: 8px;
            padding: 6px;
            text-align: center;
        }
        
        .rank-card:nth-child(2) {
            background: linear-gradient(135deg, #c0c0c0 0%, #a0a0a0 100%);
        }
        
        .rank-card:nth-child(3) {
            background: linear-gradient(135deg, #cd7f32 0%, #b06020 100%);
        }
        
        .rank-card:nth-child(n+4) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .rank-card .rank {
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .rank-card img {
            width: 45px;
            height: 45px;
            image-rendering: pixelated;
        }
        
        .rank-card .name {
            color: white;
            font-weight: bold;
            font-size: 0.65em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .rank-card .desc {
            color: rgba(255,255,255,0.85);
            font-size: 0.5em;
            font-style: italic;
            margin-top: 2px;
            line-height: 1.2;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .full-rankings {
            margin-top: 8px;
            text-align: left;
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 8px;
            min-height: 0;
        }
        
        .full-rankings h3 {
            margin-bottom: 6px;
            color: #333;
            font-size: 0.85em;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .ranking-item .position {
            width: 24px;
            font-weight: bold;
            color: #666;
            font-size: 0.8em;
        }
        
        .ranking-item img {
            width: 28px;
            height: 28px;
            image-rendering: pixelated;
        }
        
        .ranking-item .name {
            margin-left: 6px;
            color: #333;
            font-size: 0.8em;
        }
        
        .ranking-item .score {
            margin-left: auto;
            color: #888;
            font-size: 0.7em;
        }
        
        #restart-btn {
            margin-top: 8px;
            padding: 10px 24px;
            font-size: 0.9em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            touch-action: manipulation;
            flex-shrink: 0;
        }
        
        #restart-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <h1>Gen 2 Pokemon Ranker</h1>
    <p class="round-info" id="round-info">Phase 1: Selection</p>
    <p class="instructions" id="instructions">Select all your favorites from this batch!</p>
    <p class="progress">Batch <span id="current">1</span> of <span id="total">0</span></p>
    <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
    </div>
    <p class="selection-count" id="selection-count">0 favorites selected</p>
    <p class="hint" id="hint">Tip: The more selective you are, the fewer comparisons later!</p>
    
    <div class="batch-container" id="batch"></div>
    
    <div class="btn-row" id="selection-btns">
        <button class="back-btn" id="back-btn" onclick="prevBatch()" disabled>‚Üê Back</button>
        <button class="next-btn" id="next-btn" onclick="nextBatch()">Next ‚Üí</button>
    </div>
    
    <div class="battle-container" id="battle">
        <div class="battle-card" onclick="selectWinner(0)">
            <img id="battle-img1" src="" alt="">
            <p class="name" id="battle-name1"></p>
            <div class="type-container" id="battle-types1"></div>
            <p class="desc" id="battle-desc1"></p>
        </div>
        
        <span class="vs">VS</span>
        
        <div class="battle-card" onclick="selectWinner(1)">
            <img id="battle-img2" src="" alt="">
            <p class="name" id="battle-name2"></p>
            <div class="type-container" id="battle-types2"></div>
            <p class="desc" id="battle-desc2"></p>
        </div>
        </div>
    </div>
    
    <div class="btn-row" id="undo-row" style="display: none;">
        <button class="undo-btn" id="undo-btn" onclick="undoChoice()" disabled>‚Ü© Undo</button>
    </div>
    
    <div id="results">
        <h2>üèÜ Your Top Gen 2 Pokemon! üèÜ</h2>
        <div class="top-pokemon" id="top-pokemon"></div>
        <div class="full-rankings">
            <h3>Full Rankings</h3>
            <div id="full-list"></div>
        </div>
        <button id="restart-btn" onclick="restart()">Rank Again</button>
    </div>
    
    <script>
        // Gen 2 Pokemon data
        const pokemon = [
            {id: 152, name: "Chikorita", types: ["Grass"], desc: "Leaf Pok√©mon"},
            {id: 153, name: "Bayleef", types: ["Grass"], desc: "Leaf Pok√©mon"},
            {id: 154, name: "Meganium", types: ["Grass"], desc: "Herb Pok√©mon"},
            {id: 155, name: "Cyndaquil", types: ["Fire"], desc: "Fire Mouse Pok√©mon"},
            {id: 156, name: "Quilava", types: ["Fire"], desc: "Volcano Pok√©mon"},
            {id: 157, name: "Typhlosion", types: ["Fire"], desc: "Volcano Pok√©mon"},
            {id: 158, name: "Totodile", types: ["Water"], desc: "Big Jaw Pok√©mon"},
            {id: 159, name: "Croconaw", types: ["Water"], desc: "Big Jaw Pok√©mon"},
            {id: 160, name: "Feraligatr", types: ["Water"], desc: "Big Jaw Pok√©mon"},
            {id: 161, name: "Sentret", types: ["Normal"], desc: "Scout Pok√©mon"},
            {id: 162, name: "Furret", types: ["Normal"], desc: "Long Body Pok√©mon"},
            {id: 163, name: "Hoothoot", types: ["Normal", "Flying"], desc: "Owl Pok√©mon"},
            {id: 164, name: "Noctowl", types: ["Normal", "Flying"], desc: "Owl Pok√©mon"},
            {id: 165, name: "Ledyba", types: ["Bug", "Flying"], desc: "Five Star Pok√©mon"},
            {id: 166, name: "Ledian", types: ["Bug", "Flying"], desc: "Five Star Pok√©mon"},
            {id: 167, name: "Spinarak", types: ["Bug", "Poison"], desc: "String Spit Pok√©mon"},
            {id: 168, name: "Ariados", types: ["Bug", "Poison"], desc: "Long Leg Pok√©mon"},
            {id: 169, name: "Crobat", types: ["Poison", "Flying"], desc: "Bat Pok√©mon"},
            {id: 170, name: "Chinchou", types: ["Water", "Electric"], desc: "Angler Pok√©mon"},
            {id: 171, name: "Lanturn", types: ["Water", "Electric"], desc: "Light Pok√©mon"},
            {id: 172, name: "Pichu", types: ["Electric"], desc: "Tiny Mouse Pok√©mon"},
            {id: 173, name: "Cleffa", types: ["Fairy"], desc: "Star Shape Pok√©mon"},
            {id: 174, name: "Igglybuff", types: ["Normal", "Fairy"], desc: "Balloon Pok√©mon"},
            {id: 175, name: "Togepi", types: ["Fairy"], desc: "Spike Ball Pok√©mon"},
            {id: 176, name: "Togetic", types: ["Fairy", "Flying"], desc: "Happiness Pok√©mon"},
            {id: 177, name: "Natu", types: ["Psychic", "Flying"], desc: "Tiny Bird Pok√©mon"},
            {id: 178, name: "Xatu", types: ["Psychic", "Flying"], desc: "Mystic Pok√©mon"},
            {id: 179, name: "Mareep", types: ["Electric"], desc: "Wool Pok√©mon"},
            {id: 180, name: "Flaaffy", types: ["Electric"], desc: "Wool Pok√©mon"},
            {id: 181, name: "Ampharos", types: ["Electric"], desc: "Light Pok√©mon"},
            {id: 182, name: "Bellossom", types: ["Grass"], desc: "Flower Pok√©mon"},
            {id: 183, name: "Marill", types: ["Water", "Fairy"], desc: "Aqua Mouse Pok√©mon"},
            {id: 184, name: "Azumarill", types: ["Water", "Fairy"], desc: "Aqua Rabbit Pok√©mon"},
            {id: 185, name: "Sudowoodo", types: ["Rock"], desc: "Imitation Pok√©mon"},
            {id: 186, name: "Politoed", types: ["Water"], desc: "Frog Pok√©mon"},
            {id: 187, name: "Hoppip", types: ["Grass", "Flying"], desc: "Cottonweed Pok√©mon"},
            {id: 188, name: "Skiploom", types: ["Grass", "Flying"], desc: "Cottonweed Pok√©mon"},
            {id: 189, name: "Jumpluff", types: ["Grass", "Flying"], desc: "Cottonweed Pok√©mon"},
            {id: 190, name: "Aipom", types: ["Normal"], desc: "Long Tail Pok√©mon"},
            {id: 191, name: "Sunkern", types: ["Grass"], desc: "Seed Pok√©mon"},
            {id: 192, name: "Sunflora", types: ["Grass"], desc: "Sun Pok√©mon"},
            {id: 193, name: "Yanma", types: ["Bug", "Flying"], desc: "Clear Wing Pok√©mon"},
            {id: 194, name: "Wooper", types: ["Water", "Ground"], desc: "Water Fish Pok√©mon"},
            {id: 195, name: "Quagsire", types: ["Water", "Ground"], desc: "Water Fish Pok√©mon"},
            {id: 196, name: "Espeon", types: ["Psychic"], desc: "Sun Pok√©mon"},
            {id: 197, name: "Umbreon", types: ["Dark"], desc: "Moonlight Pok√©mon"},
            {id: 198, name: "Murkrow", types: ["Dark", "Flying"], desc: "Darkness Pok√©mon"},
            {id: 199, name: "Slowking", types: ["Water", "Psychic"], desc: "Royal Pok√©mon"},
            {id: 200, name: "Misdreavus", types: ["Ghost"], desc: "Screech Pok√©mon"},
            {id: 201, name: "Unown", types: ["Psychic"], desc: "Symbol Pok√©mon"},
            {id: 202, name: "Wobbuffet", types: ["Psychic"], desc: "Patient Pok√©mon"},
            {id: 203, name: "Girafarig", types: ["Normal", "Psychic"], desc: "Long Neck Pok√©mon"},
            {id: 204, name: "Pineco", types: ["Bug"], desc: "Bagworm Pok√©mon"},
            {id: 205, name: "Forretress", types: ["Bug", "Steel"], desc: "Bagworm Pok√©mon"},
            {id: 206, name: "Dunsparce", types: ["Normal"], desc: "Land Snake Pok√©mon"},
            {id: 207, name: "Gligar", types: ["Ground", "Flying"], desc: "Fly Scorpion Pok√©mon"},
            {id: 208, name: "Steelix", types: ["Steel", "Ground"], desc: "Iron Snake Pok√©mon"},
            {id: 209, name: "Snubbull", types: ["Fairy"], desc: "Fairy Pok√©mon"},
            {id: 210, name: "Granbull", types: ["Fairy"], desc: "Fairy Pok√©mon"},
            {id: 211, name: "Qwilfish", types: ["Water", "Poison"], desc: "Balloon Pok√©mon"},
            {id: 212, name: "Scizor", types: ["Bug", "Steel"], desc: "Pincer Pok√©mon"},
            {id: 213, name: "Shuckle", types: ["Bug", "Rock"], desc: "Mold Pok√©mon"},
            {id: 214, name: "Heracross", types: ["Bug", "Fighting"], desc: "Single Horn Pok√©mon"},
            {id: 215, name: "Sneasel", types: ["Dark", "Ice"], desc: "Sharp Claw Pok√©mon"},
            {id: 216, name: "Teddiursa", types: ["Normal"], desc: "Little Bear Pok√©mon"},
            {id: 217, name: "Ursaring", types: ["Normal"], desc: "Hibernator Pok√©mon"},
            {id: 218, name: "Slugma", types: ["Fire"], desc: "Lava Pok√©mon"},
            {id: 219, name: "Magcargo", types: ["Fire", "Rock"], desc: "Lava Pok√©mon"},
            {id: 220, name: "Swinub", types: ["Ice", "Ground"], desc: "Pig Pok√©mon"},
            {id: 221, name: "Piloswine", types: ["Ice", "Ground"], desc: "Swine Pok√©mon"},
            {id: 222, name: "Corsola", types: ["Water", "Rock"], desc: "Coral Pok√©mon"},
            {id: 223, name: "Remoraid", types: ["Water"], desc: "Jet Pok√©mon"},
            {id: 224, name: "Octillery", types: ["Water"], desc: "Jet Pok√©mon"},
            {id: 225, name: "Delibird", types: ["Ice", "Flying"], desc: "Delivery Pok√©mon"},
            {id: 226, name: "Mantine", types: ["Water", "Flying"], desc: "Kite Pok√©mon"},
            {id: 227, name: "Skarmory", types: ["Steel", "Flying"], desc: "Armor Bird Pok√©mon"},
            {id: 228, name: "Houndour", types: ["Dark", "Fire"], desc: "Dark Pok√©mon"},
            {id: 229, name: "Houndoom", types: ["Dark", "Fire"], desc: "Dark Pok√©mon"},
            {id: 230, name: "Kingdra", types: ["Water", "Dragon"], desc: "Dragon Pok√©mon"},
            {id: 231, name: "Phanpy", types: ["Ground"], desc: "Long Nose Pok√©mon"},
            {id: 232, name: "Donphan", types: ["Ground"], desc: "Armor Pok√©mon"},
            {id: 233, name: "Porygon2", types: ["Normal"], desc: "Virtual Pok√©mon"},
            {id: 234, name: "Stantler", types: ["Normal"], desc: "Big Horn Pok√©mon"},
            {id: 235, name: "Smeargle", types: ["Normal"], desc: "Painter Pok√©mon"},
            {id: 236, name: "Tyrogue", types: ["Fighting"], desc: "Scuffle Pok√©mon"},
            {id: 237, name: "Hitmontop", types: ["Fighting"], desc: "Handstand Pok√©mon"},
            {id: 238, name: "Smoochum", types: ["Ice", "Psychic"], desc: "Kiss Pok√©mon"},
            {id: 239, name: "Elekid", types: ["Electric"], desc: "Electric Pok√©mon"},
            {id: 240, name: "Magby", types: ["Fire"], desc: "Live Coal Pok√©mon"},
            {id: 241, name: "Miltank", types: ["Normal"], desc: "Milk Cow Pok√©mon"},
            {id: 242, name: "Blissey", types: ["Normal"], desc: "Happiness Pok√©mon"},
            {id: 243, name: "Raikou", types: ["Electric"], desc: "Thunder Pok√©mon"},
            {id: 244, name: "Entei", types: ["Fire"], desc: "Volcano Pok√©mon"},
            {id: 245, name: "Suicune", types: ["Water"], desc: "Aurora Pok√©mon"},
            {id: 246, name: "Larvitar", types: ["Rock", "Ground"], desc: "Rock Skin Pok√©mon"},
            {id: 247, name: "Pupitar", types: ["Rock", "Ground"], desc: "Hard Shell Pok√©mon"},
            {id: 248, name: "Tyranitar", types: ["Rock", "Dark"], desc: "Armor Pok√©mon"},
            {id: 249, name: "Lugia", types: ["Psychic", "Flying"], desc: "Diving Pok√©mon"},
            {id: 250, name: "Ho-Oh", types: ["Fire", "Flying"], desc: "Rainbow Pok√©mon"},
            {id: 251, name: "Celebi", types: ["Psychic", "Grass"], desc: "Time Travel Pok√©mon"}
        ];
        
        // State
        const BATCH_SIZE = 10;
        let allPokemon = [];
        let favorites = [];
        let batchSelections = []; // Store selections per batch for undo
        let batchIndex = 0;
        let totalBatches = 0;
        let currentBatch = [];
        
        // Pairwise ranking state
        let ratings = {};
        let initialRatings = {};
        let comparisons = [];
        let currentComparison = 0;
        let history = []; // For undo in pairwise phase
        const K = 32;
        
        // Helper to render type badges
        function renderTypes(types) {
            return types.map(t => 
                `<span class="type-badge type-${t.toLowerCase()}">${t}</span>`
            ).join('');
        }
        
        function init() {
            allPokemon = [...pokemon].sort(() => Math.random() - 0.5);
            favorites = [];
            batchSelections = [];
            batchIndex = 0;
            totalBatches = Math.ceil(allPokemon.length / BATCH_SIZE);
            
            // Initialize empty selections for each batch
            for (let i = 0; i < totalBatches; i++) {
                batchSelections.push(new Set());
            }
            
            document.getElementById('total').textContent = totalBatches;
            document.getElementById('selection-count').textContent = '0 favorites selected';
            
            showBatch();
        }
        
        function getTotalFavorites() {
            let count = 0;
            batchSelections.forEach(set => count += set.size);
            return count;
        }
        
        function showBatch() {
            const start = batchIndex * BATCH_SIZE;
            const end = Math.min(start + BATCH_SIZE, allPokemon.length);
            currentBatch = allPokemon.slice(start, end);
            
            const container = document.getElementById('batch');
            container.innerHTML = '';
            
            currentBatch.forEach((p) => {
                const isSelected = batchSelections[batchIndex].has(p.id);
                container.innerHTML += `
                    <div class="pokemon-card ${isSelected ? 'selected' : ''}" id="card-${p.id}" onclick="toggleSelect(${p.id})">
                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${p.id}.gif" alt="${p.name}">
                        <p class="name">${p.name}</p>
                        <div class="type-container">${renderTypes(p.types)}</div>
                        <p class="species">${p.desc}</p>
                    </div>
                `;
            });
            
            document.getElementById('current').textContent = batchIndex + 1;
            document.getElementById('progress-fill').style.width = 
                `${((batchIndex + 1) / totalBatches) * 100}%`;
            
            document.getElementById('selection-count').textContent = 
                `${getTotalFavorites()} favorites selected`;
            
            updateButtons();
        }
        
        function toggleSelect(id) {
            const card = document.getElementById(`card-${id}`);
            const currentSet = batchSelections[batchIndex];
            
            if (currentSet.has(id)) {
                currentSet.delete(id);
                card.classList.remove('selected');
            } else {
                currentSet.add(id);
                card.classList.add('selected');
            }
            
            document.getElementById('selection-count').textContent = 
                `${getTotalFavorites()} favorites selected`;
        }
        
        function updateButtons() {
            const backBtn = document.getElementById('back-btn');
            const nextBtn = document.getElementById('next-btn');
            const isLast = batchIndex >= totalBatches - 1;
            
            backBtn.disabled = batchIndex === 0;
            nextBtn.textContent = isLast ? 'Start Ranking! ‚Üí' : 'Next ‚Üí';
        }
        
        function prevBatch() {
            if (batchIndex > 0) {
                batchIndex--;
                showBatch();
            }
        }
        
        function nextBatch() {
            batchIndex++;
            
            if (batchIndex >= totalBatches) {
                // Collect all favorites
                favorites = [];
                batchSelections.forEach((set, idx) => {
                    const start = idx * BATCH_SIZE;
                    const end = Math.min(start + BATCH_SIZE, allPokemon.length);
                    const batch = allPokemon.slice(start, end);
                    set.forEach(id => {
                        const p = batch.find(p => p.id === id);
                        if (p) favorites.push(p);
                    });
                });
                
                startPairwiseRanking();
            } else {
                showBatch();
            }
        }
        
        function startPairwiseRanking() {
            if (favorites.length < 2) {
                alert('Please select at least 2 Pokemon to rank!');
                batchIndex = 0;
                init();
                return;
            }
            
            // Hide selection UI
            document.getElementById('batch').style.display = 'none';
            document.getElementById('selection-btns').style.display = 'none';
            document.getElementById('selection-count').style.display = 'none';
            document.getElementById('hint').style.display = 'none';
            
            // Show battle UI
            document.getElementById('battle').style.display = 'flex';
            document.getElementById('undo-row').style.display = 'flex';
            document.getElementById('round-info').textContent = 'Phase 2: Pairwise Ranking';
            document.getElementById('instructions').textContent = 
                `Tap your preferred Pokemon! Ranking ${favorites.length} favorites`;
            
            // Initialize ELO ratings
            ratings = {};
            initialRatings = {};
            favorites.forEach(p => {
                ratings[p.id] = 1000;
                initialRatings[p.id] = 1000;
            });
            
            // Generate comparisons
            generateComparisons();
            
            document.getElementById('total').textContent = comparisons.length;
            currentComparison = 0;
            history = [];
            showComparison();
        }
        
        function generateComparisons() {
            comparisons = [];
            const n = favorites.length;
            
            if (n <= 8) {
                for (let i = 0; i < n; i++) {
                    for (let j = i + 1; j < n; j++) {
                        comparisons.push([favorites[i], favorites[j]]);
                    }
                }
            } else {
                const numRounds = Math.ceil(Math.log2(n)) + 2;
                
                for (let round = 0; round < numRounds; round++) {
                    let shuffled = [...favorites].sort(() => Math.random() - 0.5);
                    for (let i = 0; i < shuffled.length - 1; i += 2) {
                        comparisons.push([shuffled[i], shuffled[i + 1]]);
                    }
                }
                
                const extraComparisons = Math.min(n * 2, 30);
                for (let i = 0; i < extraComparisons; i++) {
                    const idx1 = Math.floor(Math.random() * n);
                    let idx2 = Math.floor(Math.random() * n);
                    while (idx2 === idx1) {
                        idx2 = Math.floor(Math.random() * n);
                    }
                    comparisons.push([favorites[idx1], favorites[idx2]]);
                }
            }
            
            comparisons.sort(() => Math.random() - 0.5);
        }
        
        function showComparison() {
            if (currentComparison >= comparisons.length) {
                showResults();
                return;
            }
            
            const [p1, p2] = comparisons[currentComparison];
            
            document.getElementById('battle-img1').src = 
                `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${p1.id}.gif`;
            document.getElementById('battle-name1').textContent = p1.name;
            document.getElementById('battle-types1').innerHTML = renderTypes(p1.types);
            document.getElementById('battle-desc1').textContent = p1.desc;
            
            document.getElementById('battle-img2').src = 
                `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${p2.id}.gif`;
            document.getElementById('battle-name2').textContent = p2.name;
            document.getElementById('battle-types2').innerHTML = renderTypes(p2.types);
            document.getElementById('battle-desc2').textContent = p2.desc;
            
            document.getElementById('current').textContent = currentComparison + 1;
            document.getElementById('progress-fill').style.width = 
                `${(currentComparison / comparisons.length) * 100}%`;
            
            document.getElementById('undo-btn').disabled = history.length === 0;
        }
        
        function selectWinner(choice) {
            const [p1, p2] = comparisons[currentComparison];
            const winner = choice === 0 ? p1 : p2;
            const loser = choice === 0 ? p2 : p1;
            
            // Save state for undo
            history.push({
                comparison: currentComparison,
                ratings: { ...ratings }
            });
            
            // Update ELO ratings
            const expectedWinner = 1 / (1 + Math.pow(10, (ratings[loser.id] - ratings[winner.id]) / 400));
            const expectedLoser = 1 / (1 + Math.pow(10, (ratings[winner.id] - ratings[loser.id]) / 400));
            
            ratings[winner.id] += K * (1 - expectedWinner);
            ratings[loser.id] += K * (0 - expectedLoser);
            
            currentComparison++;
            showComparison();
        }
        
        function undoChoice() {
            if (history.length === 0) return;
            
            const lastState = history.pop();
            currentComparison = lastState.comparison;
            ratings = lastState.ratings;
            
            showComparison();
        }
        
        function showResults() {
            document.getElementById('battle').style.display = 'none';
            document.getElementById('undo-row').style.display = 'none';
            document.querySelector('.progress').style.display = 'none';
            document.querySelector('.progress-bar').style.display = 'none';
            document.querySelector('.instructions').style.display = 'none';
            document.querySelector('.round-info').style.display = 'none';
            document.getElementById('results').style.display = 'flex';
            
            const sorted = [...favorites].sort((a, b) => ratings[b.id] - ratings[a.id]);
            
            const topContainer = document.getElementById('top-pokemon');
            topContainer.innerHTML = '';
            for (let i = 0; i < Math.min(6, sorted.length); i++) {
                const p = sorted[i];
                topContainer.innerHTML += `
                    <div class="rank-card">
                        <div class="rank">#${i + 1}</div>
                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${p.id}.gif" alt="${p.name}">
                        <div class="name">${p.name}</div>
                        <div class="type-container">${renderTypes(p.types)}</div>
                        <div class="desc">${p.desc}</div>
                    </div>
                `;
            }
            
            const fullList = document.getElementById('full-list');
            fullList.innerHTML = '';
            sorted.forEach((p, i) => {
                fullList.innerHTML += `
                    <div class="ranking-item">
                        <span class="position">${i + 1}.</span>
                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${p.id}.gif" alt="${p.name}">
                        <span class="name">${p.name}</span>
                        <div class="type-container">${renderTypes(p.types)}</div>
                        <span class="score">${Math.round(ratings[p.id])}</span>
                    </div>
                `;
            });
        }
        
        function restart() {
            document.getElementById('batch').style.display = 'grid';
            document.getElementById('selection-btns').style.display = 'flex';
            document.getElementById('selection-count').style.display = 'block';
            document.getElementById('hint').style.display = 'block';
            document.getElementById('battle').style.display = 'none';
            document.getElementById('undo-row').style.display = 'none';
            document.querySelector('.progress').style.display = 'block';
            document.querySelector('.progress-bar').style.display = 'block';
            document.querySelector('.instructions').style.display = 'block';
            document.querySelector('.round-info').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('instructions').textContent = 'Select all your favorites from this batch!';
            document.getElementById('round-info').textContent = 'Phase 1: Selection';
            
            ratings = {};
            comparisons = [];
            currentComparison = 0;
            history = [];
            
            init();
        }
        
        // Start the app
        init();
    </script>
</body>
</html>
